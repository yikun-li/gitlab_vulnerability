from contextlib import contextmanager
from unittest.mock import MagicMock

from tests.factories import FACTORIES

@contextmanager
def generate_without_commit():
  """Removes factory session for all factories while within context - in other words, SubFactory(s) will not be commiting to the test db as well
  """
  original_session_getter = [factory._meta.sqlalchemy_session for factory in FACTORIES]
  mock_session = MagicMock()

  try:
    for factory in FACTORIES:
      factory._meta.sqlalchemy_session = mock_session
    yield
  finally:
    for factory, session in zip(FACTORIES, original_session_getter):
      factory._meta.sqlalchemy_session = session