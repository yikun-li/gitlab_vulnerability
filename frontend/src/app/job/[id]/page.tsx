"use client"

import { notFound } from "next/navigation"

import { JobDataCard } from "@/components/detection/job-data-card"
import { JobStatusScanJobCard } from "@/components/workers-status/status-scan-job-card"
import { PageTitle } from "@/components/shared/animations/page-header"
import { SecurityReportCard } from "@/components/security-report/security-report-card"

import { useStatusScanJob } from "@/hooks/use-status-scan-job"
import { useSecurityReport } from "@/hooks/use-security-report"
import { SecurityReportNavigationUtilities } from "@/components/security-report/security-report-navigation-utilities"

const JobPage = ({ params }: { params: { id: string } }) => {
  const {
    statusScanJob,
    isError: isStatusScanJobError,
    error: statusScanJobError,
    isLoading: isStatusScanJobLoading,
  } = useStatusScanJob({ dbJobId: params.id })
  const {
    securityReport,
    isError: isSecurityReportError,
    error: securityReportError,
    isLoading: isSecurityReportLoading
  } = useSecurityReport({ dbJobId: params.id })
  
  const renderJobSection = () => {
    if (!isStatusScanJobLoading && statusScanJob !== undefined) return (
      <div className="grid gap-4 md:grid-cols-2">
        <JobDataCard job={statusScanJob.job} />
        <JobStatusScanJobCard statusScanJob={statusScanJob} />
      </div>
    )
    return (
      <></>
    )
  }

  const renderSecurityReportSection = () => (
    !isStatusScanJobLoading 
      ? <SecurityReportCard
        securityReport={securityReport}
        isLoading={isSecurityReportLoading}
        isError={isSecurityReportError}
      />
      : <></>
  )

  if (isStatusScanJobError) return (
    notFound()
  )

  return (
    <div className="space-y-4">
      <PageTitle 
        title={`Job ${params.id}`}
        loadingTitle="Job"
        isLoading={isStatusScanJobLoading || isSecurityReportLoading}
        utilitySection={<SecurityReportNavigationUtilities dbJobId={params.id}/>}
      />
      {renderJobSection()}
      {renderSecurityReportSection()}
    </div>
  )
}

export default JobPage