# GitLab Vulnerability Detection Pipeline 

Repository for IS607 Vulnerability Discovery Server.

# 1. Stack
The project makes use of the following tech stack in no particular order.

* [FastAPI](https://fastapi.tiangolo.com/) _asynchronous server_
* [Alembic](https://alembic.sqlalchemy.org/en/latest/) _database migrations_
* [SQLAlchemy](https://www.sqlalchemy.org/) _ORM_
* [PostgreSQL](https://www.postgresql.org/) _database_
* [pytest](https://docs.pytest.org/en/stable/) _test suite_
* [Factory Boy](https://factoryboy.readthedocs.io/en/stable/) _test fixtures_
* [Prometheus](https://github.com/prometheus/client_python) _observability (only available in [Docker](#4-building-with-docker-compose) install)_
* [Next.js](https://nextjs.org/) _frontend framework_
* [Tailwind CSS](https://tailwindcss.com/) _styling_
* [shadcn/ui](https://ui.shadcn.com/) _styled components_

_[Back to top](#gitlab-vulnerability-detection-pipeline)_

# 2. Development Environment Set-up
Follow the steps below to get a server running locally after cloning the repository.



## 2.1. Backend

1. Create a [Python virtual environment](https://realpython.com/python-virtual-environments-a-primer/).

2. Install requirements from the [backend](./backend) sub-directory.
```
pip install -r requirements.txt
```

3. Install PostgreSQL on your local machine. 

4. Create a new `.env` file from `.env.example`. The steps to retrieve the GitLab related tokens have been outlined in the project set-up guide [here](https://docs.google.com/document/d/1_-YJlWVVLTFPRGOcYA9XfxT4XPXqUUmfSMDdoHLOM9c/edit?usp=sharing). Here is a list of the basic changes required:
    - `DATABASE_USER`
    - `DATABASE_PASSWORD`
    - `DATABASE_NAME`
    - `GITLAB_ACCESS_TOKEN` _This is retrieved from GitLab. You can make use of either an individual access token or a project access token._
    - `GITLAB_PIPELINE_TRIGGER_TOKEN` _This is retrieved from GitLab._

> Note: you should instantiate a database, either through the CLI (`createdb <DATABASE_NAME> -O <DATABASE_USER>`) or through a GUI, before running the migrations below.

5. Run migrations with alembic from the [root folder](./backend/) to update the database.
```
alembic upgrade head
```

6. Start server by running [main.py](./backend/app/main.py) from within `/backend`.
```
fastapi dev app/main.py
```

7. Visit `http://127.0.0.1:8000/docs` to view the server endpoints and documentation.

_[Back to top](#gitlab-vulnerability-detection-pipeline)_

## 2.2. Frontend

1. To get started on the frontend, we'll need to install the respective dependencies.
```
npm i
```

2. Run the following command to get the Next.js app started.
```
npm run dev
```

3. Navigate to `http://localhost:3000` to view the server homepage.

_[Back to top](#gitlab-vulnerability-detection-pipeline)_

## 2.3. GitLab
To conduct and test integration with GitLab from our local servers, we need to expose our local server through a proxy. We can make use of [ngrok](https://ngrok.com/) for this.

1. Run the server locally as per steps outlined above.

2. Open a separate terminal and expose the server through the ngrok proxy.
```
ngrok http http://127.0.0.1:8000
```

3. Change respective links `.gitlab-ci.yml` file in the target repository.

4. Pushing new commits to the target repository should trigger a API calls to our local servers through the ngrok proxy.

_[Back to top](#gitlab-vulnerability-detection-pipeline)_

# 3. Testing
As the focus of the project is a backend pipeline, we make use of unit tests on the backend to garner confidence in the behaviour of the product. Run the `pytest` command from the [root backend directory](backend/) to begin testing the test suite.

_[Back to top](#gitlab-vulnerability-detection-pipeline)_

<!-- ### Load Tests
We conduct load tests with [locust](https://locust.io/). All load testing files can be found in `backend/tests/load`.

To run the load tests, navigate to `/backend` and run `locust -f tests/load`. Click the generated link and use the GUI to configure your desired tests. -->

# 4. Building with Docker-compose
>Note: Docker files have been configured in order to accomodate observability. This was done initially to help us determine the performance of our servers during initial load tests. This have since not been maintained and used. The documentation outlined below demonstrates how it has been used previously and should still be relevant since the compose files are mainly configurations and nothing has been changed with regards to the database environment variables.

---

After changing relevant `.env` variables in step 4 of the [Development Environment Set-up](#2-development-environment-set-up), runing the docker-compose scripts will either build or rebuild the server and database, running all migrations.

```
docker compose up

# or

docker-compose up --build
```

> Note: to remove volumes during a compose shutdown, run `docker-compose down --volumes`. Required if you run into an error stating volumes have already been initialised.

_[Back to top](#gitlab-vulnerability-detection-pipeline)_

# 5. GitLab Scripts
A separate README.md file has been written [here](backend/scripts/gitlab/README.md) to guide developers on how they can make use of GitLab's Ruby validation scripts.

_[Back to top](#gitlab-vulnerability-detection-pipeline)_
